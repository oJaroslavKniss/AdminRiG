package com.rig.jarrig;

import java.io.File;
import java.io.InputStream;

import com.jcraft.jsch.Channel;
import com.jcraft.jsch.ChannelExec;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.Session;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.util.FilesystemContainer;
import com.vaadin.event.Transferable;
import com.vaadin.event.dd.DragAndDropEvent;
import com.vaadin.event.dd.DropHandler;
import com.vaadin.event.dd.acceptcriteria.AcceptAll;
import com.vaadin.event.dd.acceptcriteria.AcceptCriterion;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.DragAndDropWrapper;
import com.vaadin.ui.Label;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.Tree;
import com.vaadin.ui.Tree.TreeDragMode;

public class RigComponents extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private AbsoluteLayout mainLayout;
    @AutoGenerated
    private Button checkInstalled;
    @AutoGenerated
    private Tree filesystem;
    @AutoGenerated
    private TextArea consoleOutput;
    @AutoGenerated
    private Button delete;
    @AutoGenerated
    private Button addNew;
    @AutoGenerated
    private Label projectName;
    @AutoGenerated
    private Button custominstall;
    @AutoGenerated
    private Button releaseinstall;
    @AutoGenerated
    private Button dailyinstall;
    @AutoGenerated
    private TextField custom;
    @AutoGenerated
    private TextField release;
    @AutoGenerated
    private TextField daily;
    @AutoGenerated
    private ComboBox IPs;
    String user = "root";
    String password = "root";
    String host1 = "10.96.20.190";
    String host2 = "10.96.20.170";
    String host3 = "10.96.20.73";
    int port = 22;
    String remoteFile = "/media/user/testSSH.txt";
    String line;
    DragAndDropWrapper dndWrapper;
    JSch jsch = new JSch();
    Session session;
    Channel channel;
    String deleteRpms = "rpm --nodeps -e NGI_CI_OIBAdapter_Access NGI_CI_OIB_Access NGI_CI_OIB_Dump_Access NGI_CI_OIB_Configuration_Access NGI_CI_OIB_ChromeUI_Access NGI_CI_WebRuntimeAdapter_Access NGI_CI_WebRuntime_Access NGI_CI_Fonts_Access";
    String installRpms = "cd /media/user/20160217*\n rpm -ivh *.rpm";
    String checkInstalledRpms = "rpm -qa | grep NGI_CI";

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     *
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */
    public RigComponents() {
	buildMainLayout();
	setCompositionRoot(mainLayout);
	openSSHConnection();
	registerWrapper();
	initFileExplorer();
	initButtonsListener();
	IPs.addItem(host1);
	IPs.addItem(host2);
	IPs.addItem(host3);

	// TODO add user code here
    }

    private void initButtonsListener() {
	initButtonDailyInstall();
	initButtonDelete();
	initButtonInstalled();
    }

    private void initButtonInstalled() {
	checkInstalled.addClickListener(new ClickListener() {

	    public void buttonClick(ClickEvent event) {
		((ChannelExec) channel).setCommand(checkInstalledRpms);
		updateOutputConsole(checkInstalledRpms);
	    }
	});
    }

    private void initButtonDelete() {
	delete.addClickListener(new ClickListener() {

	    public void buttonClick(ClickEvent event) {
		((ChannelExec) channel).setCommand(deleteRpms);
		updateOutputConsole(deleteRpms);
	    }
	});
    }

    private void initButtonDailyInstall() {
	dailyinstall.addClickListener(new ClickListener() {
	    public void buttonClick(ClickEvent event) {
		((ChannelExec) channel).setCommand(installRpms);
		updateOutputConsole(installRpms);
	    }
	});

    }

    private void updateOutputConsole(String operation) {
	try {
	    InputStream in = channel.getInputStream();
	    channel.connect();
	    String outStream = operation + "\n";
	    byte[] tmp = new byte[1024];
	    while (true) {
		while (in.available() > 0) {
		    int i = in.read(tmp, 0, 1024);
		    if (i < 0)
			break;
		    outStream = outStream + new String(tmp, 0, i);
		    System.out.print(new String(tmp, 0, i));
		}
		if (channel.isClosed()) {
		    if (in.available() > 0)
			continue;
		    System.out.println("exit-status: " + channel.getExitStatus());
		    break;
		}
	    }
	    consoleOutput.setValue(outStream);
	} catch (Exception e) {
	    System.out.println(e);
	}
    }

    private void initFileExplorer() {
	FilesystemContainer rigDocs = new FilesystemContainer(new File("C:/Users/jaroslav.kniss/Downloads/"), false);
	filesystem.setContainerDataSource(rigDocs);
	filesystem.setImmediate(true);
	filesystem.setSelectable(true);
	filesystem.setDragMode(TreeDragMode.NODE);
    }

    @SuppressWarnings({ "deprecation", "serial" })
    private void registerWrapper() {
	dndWrapper = new DragAndDropWrapper(daily);
	dndWrapper.setDropHandler(new DropHandler() {

	    public AcceptCriterion getAcceptCriterion() {
		return AcceptAll.get();
	    }

	    // get item selected in the filesystem list and put it to dropped
	    // textfield item
	    public void drop(DragAndDropEvent event) {
		Transferable t = event.getTransferable();
		Object sourceItemId = t.getData("itemId");
		daily.setValue(sourceItemId.toString());
	    }
	});

	dndWrapper.setWidth(daily.getWidth(), UNITS_PIXELS);
	dndWrapper.setCaption("Daily Build rpms");
	mainLayout.addComponent(dndWrapper, "top:120.0px;left:60.0px;");
    }

    private void openSSHConnection() {
	try {
	    session = jsch.getSession(user, host1, port);
	    session.setPassword(password);
	    session.setConfig("StrictHostKeyChecking", "no");
	    session.connect();
	    channel = session.openChannel("exec");

	    // InputStream in_stream = new
	    // ByteArrayInputStream("ls".getBytes(StandardCharsets.UTF_8));
	    // channel.setInputStream(null);

	    // channel.setOutputStream();
	    // ((ChannelExec) channel).setErrStream(System.err);

	    // ChannelSftp sftpChannel = (ChannelSftp)
	    // session.openChannel("sftp");
	    // sftpChannel.connect();
	    // System.out.println("SSH Channel created.");

	    // InputStream out= null;
	    // out= sftpChannel.get(remoteFile);
	    // BufferedReader br = new BufferedReader(new
	    // InputStreamReader(out));
	    // while ((line = br.readLine()) != null)
	    // System.out.println(line);
	    // br.close();

	} catch (Exception e) {
	    System.err.print(e);
	}
    }

    @AutoGenerated
    private AbsoluteLayout buildMainLayout() {
	// common part: create layout
	mainLayout = new AbsoluteLayout();
	mainLayout.setImmediate(false);
	mainLayout.setWidth("1920px");
	mainLayout.setHeight("1000px");

	// top-level component properties
	setWidth("1920px");
	setHeight("1000px");

	// IPs
	IPs = new ComboBox();
	IPs.setCaption("IP");
	IPs.setImmediate(false);
	IPs.setWidth("200px");
	IPs.setHeight("-1px");
	mainLayout.addComponent(IPs, "top:60.0px;left:60.0px;");

	// daily
	daily = new TextField();
	daily.setCaption("Daily Build rpms");
	daily.setImmediate(false);
	daily.setWidth("200px");
	daily.setHeight("-1px");
	mainLayout.addComponent(daily, "top:120.0px;left:60.0px;");

	// release
	release = new TextField();
	release.setCaption("Release rpms");
	release.setImmediate(false);
	release.setWidth("200px");
	release.setHeight("-1px");
	mainLayout.addComponent(release, "top:180.0px;left:59.0px;");

	// custom
	custom = new TextField();
	custom.setCaption("Custom rpms");
	custom.setImmediate(false);
	custom.setWidth("200px");
	custom.setHeight("-1px");
	mainLayout.addComponent(custom, "top:240.0px;left:59.0px;");

	// dailyinstall
	dailyinstall = new Button();
	dailyinstall.setCaption("install");
	dailyinstall.setImmediate(true);
	dailyinstall.setWidth("-1px");
	dailyinstall.setHeight("-1px");
	mainLayout.addComponent(dailyinstall, "top:120.0px;left:279.0px;");

	// releaseinstall
	releaseinstall = new Button();
	releaseinstall.setCaption("install");
	releaseinstall.setImmediate(true);
	releaseinstall.setWidth("-1px");
	releaseinstall.setHeight("-1px");
	mainLayout.addComponent(releaseinstall, "top:180.0px;left:279.0px;");

	// custominstall
	custominstall = new Button();
	custominstall.setCaption("install");
	custominstall.setImmediate(true);
	custominstall.setWidth("-1px");
	custominstall.setHeight("-1px");
	mainLayout.addComponent(custominstall, "top:240.0px;left:279.0px;");

	// projectName
	projectName = new Label();
	projectName.setImmediate(false);
	projectName.setWidth("-1px");
	projectName.setHeight("-1px");
	projectName.setValue("JarRiG");
	mainLayout.addComponent(projectName, "top:11.0px;left:11.0px;");

	// addNew
	addNew = new Button();
	addNew.setCaption("Add");
	addNew.setImmediate(true);
	addNew.setWidth("-1px");
	addNew.setHeight("-1px");
	mainLayout.addComponent(addNew, "top:60.0px;left:278.0px;");

	// delete
	delete = new Button();
	delete.setCaption("uninstall");
	delete.setImmediate(true);
	delete.setWidth("-1px");
	delete.setHeight("158px");
	mainLayout.addComponent(delete, "top:120.0px;left:381.0px;");

	// consoleOutput
	consoleOutput = new TextArea();
	consoleOutput.setCaption("Console Output");
	consoleOutput.setImmediate(false);
	consoleOutput.setWidth("754px");
	consoleOutput.setHeight("338px");
	mainLayout.addComponent(consoleOutput, "top:422.0px;left:520.0px;");

	// filesystem
	filesystem = new Tree();
	filesystem.setCaption("Filesystem");
	filesystem.setImmediate(false);
	filesystem.setWidth("-1px");
	filesystem.setHeight("329px");
	mainLayout.addComponent(filesystem, "top:29.0px;left:525.0px;");

	// checkInstalled
	checkInstalled = new Button();
	checkInstalled.setCaption("installed Rpms");
	checkInstalled.setImmediate(false);
	checkInstalled.setWidth("-1px");
	checkInstalled.setHeight("-1px");
	mainLayout.addComponent(checkInstalled, "top:314.0px;left:278.0px;");

	return mainLayout;
    }

}
